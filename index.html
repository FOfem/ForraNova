<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ForraNova Academy-Live</title>

<style>
/* =============================
   GLOBAL STYLES
============================= */
body{
    margin:0;
    font-family: 'Segoe UI', sans-serif;
    background: radial-gradient(circle at center, #0f2027, #203a43, #2c5364);
    color:white;
    overflow:hidden;
}

.hidden{ display:none; }

h1,h2,h3{ margin:0; }

button{
    background: linear-gradient(45deg,#00c6ff,#0072ff);
    border:none;
    padding:8px 14px;
    color:white;
    border-radius:8px;
    cursor:pointer;
    margin:4px 0;
}

select,input{
    width:100%;
    padding:6px;
    margin:6px 0;
    border-radius:6px;
    border:none;
}

/* =============================
   INITIALIZER
============================= */
#initializer{
    position:absolute;
    width:100%;
    height:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
}

.progress-container{
    width:60%;
    background:#222;
    border-radius:20px;
    margin-top:20px;
}

.progress-bar{
    height:12px;
    width:0%;
    background:#00f2ff;
    border-radius:20px;
}

/* =============================
   LAYOUT
============================= */
#academy{
    display:flex;
    height:100vh;
}

#sidebar{
    width:260px;
    background:rgba(0,0,0,0.4);
    backdrop-filter:blur(15px);
    padding:20px;
    overflow:auto;
}

#main{
    flex:1;
    display:flex;
    flex-direction:column;
    position:relative;
}

#chat{
    flex:1;
    overflow:auto;
    padding:20px;
}

.message{
    background:rgba(255,255,255,0.1);
    padding:12px;
    border-radius:12px;
    margin-bottom:10px;
}

.controls{
    display:flex;
    padding:10px;
    background:rgba(0,0,0,0.3);
}

#userInput{
    flex:1;
    padding:10px;
    border-radius:8px;
    border:none;
}

/* =============================
   WAVE ANIMATION
============================= */
#waveCanvas{
    position:absolute;
    bottom:0;
    width:100%;
    height:200px;
    pointer-events:none;
}

/* =============================
   ONBOARDING MODAL
============================= */
#onboarding{
    position:absolute;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.85);
    display:flex;
    justify-content:center;
    align-items:center;
}

.onboard-box{
    background:#1e2a38;
    padding:30px;
    border-radius:12px;
    width:300px;
}
</style>
</head>
<body>

<!-- =============================
     INITIALIZER
============================= -->
<div id="initializer">
    <h1>ForraNova Academy-Live</h1>
    <p>Knowledge Is For the Living</p>
    <div class="progress-container">
        <div class="progress-bar" id="progress"></div>
    </div>
</div>

<!-- =============================
     ONBOARDING
=============================
<div id="onboarding" class="hidden">
    <div class="onboard-box">
        <h2>Welcome to ForraNova</h2>
        <input type="text" id="nameInput" placeholder="Enter Your Name">
        <input type="file" id="avatarInput" accept="image/*">
        <button onclick="saveUser()">Enter Academy</button>
    </div>
</div>
 -->
<!-- =============================
     ACADEMY
============================= -->
<div id="academy" class="hidden">

    <div id="sidebar">
        <h2>ForraNova Academy-Live</h2>
        <hr>

        <img id="userAvatar" width="80" style="border-radius:50%">
        <h3 id="userName"></h3>

        <hr>
        <label>AI Voice</label>
        <select id="voiceSelect"></select>

        <label>Persona</label>
        <select id="personaSelect">
            <option value="0.2">Professor</option>
            <option value="0.5">Friendly Ali</option>
            <option value="0.8">Comedian</option>
        </select>

        <label>Subject</label>
        <select id="subjectSelect"></select>
        <button onclick="addSubject()">+ Add Subject</button>

        <label>Level</label>
        <select id="levelSelect">
            <option>General</option>
            <option>Basic / Primary</option>
            <option>Junior Secondary</option>
            <option>Senior Secondary</option>
            <option>Undergraduate / Graduate</option>
            <option>Masters / PhD</option>
        </select>
    </div>

    <div id="main">
        <div id="chat"></div>

        <div class="controls">
            <input id="userInput" placeholder="Ask something...">
            <button onclick="startMic()">ðŸŽ¤</button>
            <button onclick="sendMessage()">Send</button>
        </div>

        <canvas id="waveCanvas"></canvas>
    </div>

</div>

<script>
/* ======================================================
   FORRANOVA ACADEMY - PRODUCTION CORE ENGINE
   Hardened | Streaming | Mobile-First | PWA Ready
====================================================== */

/* ===============================
   GLOBAL STATE
=============================== */

let appState = {
    user: null,
    voices: [],
    currentUtterance: null,
    animationFrameId: null,
    recognition: null,
    isSpeaking: false,
    isStreaming: false
};

const wisdomDB = [
    "Proverbs 4:7 - Wisdom is the most important thing.",
    "Ecclesiastes 7:12 - Wisdom is a protection.",
    "James 1:5 - If any of you lacks wisdom, let him ask God."
];

/* ===============================
   INITIALIZATION
=============================== */

document.addEventListener("DOMContentLoaded", () => {
    startInitializer();
    setupPWAInstall();
});

/* ===============================
   INITIALIZER
=============================== */

function startInitializer() {
    let progress = 0;
    const bar = document.getElementById("progress");
    const initializer = document.getElementById("initializer");

    const interval = setInterval(() => {
        progress += 5;
        bar.style.width = progress + "%";

        if (progress >= 100) {
            clearInterval(interval);
            initializer.classList.add("hidden");

            const stored = safeParse(localStorage.getItem("forraUser"));
            if (stored && stored.name && stored.avatar) {
                appState.user = stored;
                loadAcademy();
            } else {
                document.getElementById("onboarding").classList.remove("hidden");
            }
        }
    }, 80);
}

/* ===============================
   SAFE JSON PARSER
=============================== */

function safeParse(data) {
    try {
        return JSON.parse(data);
    } catch {
        return null;
    }
}

/* ===============================
   USER STORAGE
=============================== */

window.saveUser = function () {
    const name = document.getElementById("nameInput").value.trim();
    const file = document.getElementById("avatarInput").files[0];

    if (!name || !file) {
        alert("Enter Name and Avatar");
        return;
    }

    const reader = new FileReader();
    reader.onload = e => {
        appState.user = {
            name,
            avatar: e.target.result,
            subjects: ["Biology", "Chemistry", "Physics"]
        };
        localStorage.setItem("forraUser", JSON.stringify(appState.user));
        document.getElementById("onboarding").classList.add("hidden");
        loadAcademy();
    };
    reader.readAsDataURL(file);
};

/* ===============================
   LOAD ACADEMY
=============================== */

function loadAcademy() {
    document.getElementById("academy").classList.remove("hidden");

    document.getElementById("userName").textContent = appState.user.name;
    document.getElementById("userAvatar").src = appState.user.avatar;

    renderSubjects();
    initVoices();
    initMic();
    welcomeUser();
}

/* ===============================
   SUBJECTS
=============================== */

function renderSubjects() {
    const select = document.getElementById("subjectSelect");
    select.innerHTML = "";

    (appState.user.subjects || []).forEach(sub => {
        const opt = document.createElement("option");
        opt.textContent = sub;
        select.appendChild(opt);
    });
}

window.addSubject = function () {
    const sub = prompt("Enter Subject");
    if (!sub) return;

    appState.user.subjects.push(sub);
    localStorage.setItem("forraUser", JSON.stringify(appState.user));
    renderSubjects();
};

/* ===============================
   WISDOM
=============================== */

function randomWisdom() {
    return wisdomDB[Math.floor(Math.random() * wisdomDB.length)];
}

/* ===============================
   VOICE ENGINE (HARDENED)
=============================== */

function initVoices() {
    function load() {
        appState.voices = speechSynthesis.getVoices();
        const select = document.getElementById("voiceSelect");
        select.innerHTML = "";

        appState.voices.forEach((v, i) => {
            const opt = document.createElement("option");
            opt.value = i;
            opt.textContent = v.name;
            select.appendChild(opt);
        });
    }

    load();
    speechSynthesis.onvoiceschanged = load;
}

function speak(text) {
    if (!("speechSynthesis" in window)) return;

    speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(text);
    const voiceIndex = document.getElementById("voiceSelect").value;
    utter.voice = appState.voices[voiceIndex] || null;

    utter.onstart = () => {
        appState.isSpeaking = true;
        startWaveAnimation();
    };

    utter.onend = () => {
        appState.isSpeaking = false;
        stopWaveAnimation();
    };

    speechSynthesis.speak(utter);
    appState.currentUtterance = utter;
}

/* ===============================
   STREAMING AI ENGINE
=============================== */

window.sendMessage = async function () {
    const inputEl = document.getElementById("userInput");
    const question = inputEl.value.trim();
    if (!question || appState.isStreaming) return;

    inputEl.value = "";
    appendMessage("You", question);

    const subject = document.getElementById("subjectSelect").value;
    const level = document.getElementById("levelSelect").value;
    const temp = document.getElementById("personaSelect").value;

    const systemPrompt = `
You are a professional teaching AI.
Student: ${appState.user.name}
Subject: ${subject}
Level: ${level}
Creativity: ${temp}
Respond clearly and educationally.
    `;

    appState.isStreaming = true;

    const responseContainer = appendMessage("AI", "");

    try {
        const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                system: systemPrompt,
                user: question,
                stream: true
            })
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();

        let fullText = "";

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            fullText += chunk;
            responseContainer.textContent = fullText;
            scrollChat();
        }

        speak(fullText);

    } catch (err) {
        responseContainer.textContent = "AI connection error.";
    }

    appState.isStreaming = false;
};

/* ===============================
   CHAT UI
=============================== */

function appendMessage(sender, text) {
    const chat = document.getElementById("chat");

    const div = document.createElement("div");
    div.className = "message";

    const strong = document.createElement("strong");
    strong.textContent = sender + ": ";

    const span = document.createElement("span");
    span.textContent = text;

    const copyBtn = document.createElement("button");
    copyBtn.textContent = "Copy";
    copyBtn.onclick = () => {
        navigator.clipboard?.writeText(span.textContent).catch(()=>{});
    };

    div.appendChild(strong);
    div.appendChild(span);
    div.appendChild(document.createElement("br"));
    div.appendChild(copyBtn);

    chat.appendChild(div);
    scrollChat();

    return span;
}

function scrollChat() {
    const chat = document.getElementById("chat");
    chat.scrollTop = chat.scrollHeight;
}

/* ===============================
   MICROPHONE
=============================== */

function initMic() {
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRec) return;

    appState.recognition = new SpeechRec();
    appState.recognition.lang = "en-US";

    appState.recognition.onresult = e => {
        document.getElementById("userInput").value = e.results[0][0].transcript;
    };
}

window.startMic = function () {
    if (!appState.recognition) {
        alert("Speech recognition not supported.");
        return;
    }
    appState.recognition.start();
};

/* ===============================
   WAVE ANIMATION (SAFE LOOP)
=============================== */

function startWaveAnimation() {
    const canvas = document.getElementById("waveCanvas");
    const ctx = canvas.getContext("2d");

    canvas.width = window.innerWidth;
    canvas.height = 200;

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();

        for (let x = 0; x < canvas.width; x++) {
            let y = 100 + Math.sin(x * 0.02 + Date.now() / 200) * 20;
            ctx.lineTo(x, y);
        }

        ctx.strokeStyle = "#00f2ff";
        ctx.stroke();

        appState.animationFrameId = requestAnimationFrame(draw);
    }

    draw();
}

function stopWaveAnimation() {
    cancelAnimationFrame(appState.animationFrameId);
}

/* ===============================
   WELCOME MESSAGE
=============================== */

function welcomeUser() {
    const msg = `Welcome ${appState.user.name} to ForraNova Academy. Here, we believe 'Knowledge Is For the Living.' Before we begin, keep this thought in mind: ${randomWisdom()}. Now, what would you like to learn?`;
    appendMessage("AI", msg);
    speak(msg);
}

/* ===============================
   PWA SUPPORT
=============================== */

function setupPWAInstall() {
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("sw.js").catch(()=>{});
    }
}
</script>

</body>
</html>
